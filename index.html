<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบเช็คชื่อด้วย GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    input, button { font-size: 1.2em; padding: 10px; width: 100%; margin-top: 10px; }
    #status { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ระบบเช็คชื่อด้วย GPS</h2>
  <div id="form-area" style="display: none;">
    <input type="email" id="email" placeholder="กรอกอีเมลของคุณ" required>
    <button onclick="submitData()">ส่งข้อมูล</button>
  </div>
  <div id="status">กำลังตรวจสอบตำแหน่งของคุณ...</div>

  <script>
    const targetLat = 15.223933;
    const targetLng = 104.933856;
    const maxDistance = 200; // หน่วยเป็นเมตร
    let userLat, userLng, distance, isOutOfRange = false;

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function getLocation() {
      if (!navigator.geolocation) {
        document.getElementById("status").innerText = "เบราว์เซอร์ไม่รองรับการระบุตำแหน่ง";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          distance = haversineDistance(userLat, userLng, targetLat, targetLng);
          isOutOfRange = distance > maxDistance;

          document.getElementById("form-area").style.display = "block";
          document.getElementById("status").innerText = 
            `คุณอยู่ห่างจากจุดเช็คชื่อประมาณ ${Math.round(distance)} เมตร` + 
            (isOutOfRange ? " (เกินระยะที่กำหนด)" : "");
        },
        (err) => {
          document.getElementById("status").innerText = "กรุณาเปิด GPS และอนุญาตให้เข้าถึงตำแหน่ง";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function submitData() {
      const email = document.getElementById("email").value.trim();
      if (!email) {
        alert("กรุณากรอกอีเมลก่อนส่งข้อมูล");
        return;
      }

      const now = new Date();
      const timestamp = now.toLocaleString("th-TH");

      const payload = {
        email,
        timestamp,
        lat: userLat,
        lng: userLng,
        distance: Math.round(distance),
        note: isOutOfRange ? "อยู่นอกระยะมากกว่า 200 เมตร" : ""
      };

      fetch("https://script.google.com/macros/s/AKfyc....YOUR_SCRIPT_ID....../exec", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.text())
      .then(msg => {
        document.getElementById("status").innerText = "✅ ส่งข้อมูลเรียบร้อยแล้ว";
        document.getElementById("form-area").style.display = "none";
      })
      .catch(err => {
        document.getElementById("status").innerText = "❌ ส่งข้อมูลไม่สำเร็จ: " + err;
      });
    }

    getLocation();
  </script>
</body>
</html>
