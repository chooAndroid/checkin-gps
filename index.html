<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>เช็คชื่อด้วย GPS</title>
</head>
<body>
  <h1>ระบบเช็คชื่อด้วย GPS</h1>
  <form id="form">
    <label for="name">ชื่อ:</label>
    <input type="text" id="name" name="name" required><br><br>

    <label for="status">สถานะ:</label>
    <select id="status" name="status">
      <option value="มาเรียน">มาเรียน</option>
      <option value="ขาดเรียน">ขาดเรียน</option>
      <option value="สาย">สาย</option>
    </select><br><br>

    <button type="submit">เช็คชื่อ</button>
  </form>

  <p style="color:red; font-weight:bold;">
    * หากคุณใช้ Android กรุณาเปิดเว็บนี้ใน Chrome เท่านั้น<br>
    (หากเปิดจาก LINE, Facebook หรือแอปอื่น → ให้กดปุ่ม ⋮ แล้วเลือก “เปิดใน Chrome”)
  </p>

  <p id="debug" style="color:blue;"></p>
  <p id="result" style="color:green;"></p>

  <script>
    const lat_home = 15.223933;
    const lng_home = 104.933856;

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      var R = 6371e3;
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLon = (lon2 - lon1) * Math.PI / 180;
      var a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c;
      return d;
    }

    let userLat = null, userLng = null;

    navigator.geolocation.getCurrentPosition(function (position) {
      userLat = position.coords.latitude;
      userLng = position.coords.longitude;
      const dist = getDistanceFromLatLonInMeters(userLat, userLng, lat_home, lng_home);

      document.getElementById("debug").innerHTML =
        `Lat: ${userLat.toFixed(6)}<br>
         Lng: ${userLng.toFixed(6)}<br>
         Distance: ${dist.toFixed(2)} m`;
    }, function (error) {
      document.getElementById("debug").innerText = "ไม่สามารถเข้าถึงตำแหน่งได้ กรุณาอนุญาตการเข้าถึงตำแหน่ง";
    });

    document.getElementById("form").addEventListener("submit", function (e) {
      e.preventDefault();
      if (userLat === null || userLng === null) {
        alert("กำลังโหลดตำแหน่ง กรุณารอสักครู่แล้วลองใหม่อีกครั้ง");
        return;
      }

      const dist = getDistanceFromLatLonInMeters(userLat, userLng, lat_home, lng_home);
      if (dist > 20) {
        alert("❌ คุณอยู่ห่างเกิน 20 เมตร ไม่สามารถเช็คชื่อได้");
        return;
      }

      const name = document.getElementById("name").value;
      const status = document.getElementById("status").value;

      fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
        method: "POST",
        body: JSON.stringify({ name, status, lat: userLat, lng: userLng }),
        headers: { "Content-Type": "application/json" }
      })
        .then(res => res.text())
        .then(data => {
          document.getElementById("result").innerText = "✅ บันทึกสำเร็จ: " + name;
        })
        .catch(err => {
          document.getElementById("result").innerText = "❌ เกิดข้อผิดพลาด: " + err.message;
        });
    });
  </script>
</body>
</html>
